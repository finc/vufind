<!-- finc - documentdeliveryservice - form -->

  <div class="<?=$this->layoutClass('mainbody')?>">
    <h2><?=$this->transEsc('DDS::dds_form_headline')?></h2>
    <?=$this->flashmessages()?>
    <form method="post" action="<?=$this->url('dds-email')?>" name="docdelisForm">
      <? if ($this->department): ?>
        <input type="hidden" name="subito[hdepartment]" value="<?=$this->department?>"/>
      <? endif; ?>
        <legend><?=$this->transEsc("DDS::dds_form_delivery_data")?>:</legend>
        <!-- name -->
        <div class="form-group">
          <label for="sname" class="control-label"><?=$this->transEsc("Name")?>:*</label>
          <? if (isset($this->error->username)): ?>
            <div class="error-field">
              <?=$this->error->username;?>
            </div>
          <? endif; ?>

          <input type="text" id="sname" name="subito[username]" class="form-control" <?=(!empty($this->username) ? 'value="' . $this->username . '"' : '')?>/>

        </div>
        <!-- phone -->
        <div class="form-group">
          <label class="inline control-label" for="sphone"><?=$this->transEsc("DDS::form_field_phone")?>:</label>
          <? if (isset($this->error->phone)): ?>
            <div class="error-field">
              <?=$this->error->phone;?>
            </div>
          <? endif; ?>
          <input type="text" id="sphone" name="subito[phone]" class="form-control" <?=(!empty($this->phone) ? 'value="' . $this->phone . '"' : '')?>/>
        </div>
        <!-- email -->
        <div class="form-group">
          <label class="inline control-label" for="semail"><?=$this->transEsc("DDS::form_field_email")?>:*</label>
          <? if (isset($this->error->email)): ?>
            <div class="error-field">
              <?=$this->error->email;?>
            </div>
          <? endif; ?>
          <input type="text" id="semail" name="subito[email]" class="form-control" <?=(!empty($this->email) ? 'value="' . $this->email . '"' : '')?>/>
        </div>
        <!-- user id -->
        <div class="form-group">
          <label class="inline control-label" for="suserid"><?=$this->transEsc("DDS::form_field_library_id")?>:*</label>
          <? if (isset($this->error->userid)): ?>
            <div class="error-field">
              <?=$this->error->userid;?>
            </div>
          <? endif; ?>
          <input type="text" id="suserid" name="subito[userid]" class="form-control" <?=(!empty($this->userid) ? 'value="' . $this->userid . '"' : '')?>/>
        </div>
        <!-- division -->
        <div class="form-group">
          <label class="inline control-label" for="sdivision"><?=$this->transEsc("DDS::form_field_division")?>:*</label>
          <? if (isset($this->error->division)): ?>
            <div class="error-field">
              <?=$this->error->division;?>
            </div>
          <? endif; ?>
          <select id="sdivision" name="subito[division]" size="1" class="form-control"/>
          <option value=""></option>
          <? foreach ($this->divisions as $cat => $division): ?>
            <option value="<?=$cat?>" <?=($this->division == $cat) ? 'selected="selected"' : ''?>><?=$division?></option>
          <? endforeach; ?>
          </select>
        </div>
        <!-- department -->
        <div class="form-group input-sdepartment">
          <label class="inline control-label" for="sdepartment"><?=$this->transEsc("DDS::form_field_department")?>:*</label>
          <? if (isset($this->error->department)): ?>
            <div class="error-field">
              <?=$this->error->department;?>
            </div>
          <? endif; ?>
          <select id="sdepartment" name="subito[department]" size="1" class="form-control"/>
          <option value=""></option>
          </select>
        </div>
        <!-- department medicine -->
        <div class="form-group input-department">
          <label class="inline control-label" for="smdepartment"><?=$this->transEsc("DDS::form_field_department")?>:*</label>
            <input type="text" id="smdepartment" name="subito[inputdepartment]" class="form-control" <?=(!empty($this->inputdepartment) ? 'value="' . $this->inputdepartment . '"' : '')?>/>
        </div>

        <legend><?=$this->transEsc("DDS::dds_form_details_ordered_title")?>:</legend>
        <!-- author -->
        <div class="form-group">
          <label class="inline control-label" for="sauthor"><?=$this->transEsc("DDS::form_field_author")?>:*</label>
          <? if (isset($this->error->author)): ?>
            <div class="error-field">
              <?=$this->error->author;?>
            </div>
          <? endif; ?>
          <input type="text" id="sauthor" name="subito[author]" class="form-control" <?=(!empty($this->author) ? 'value="' . $this->author . '"' : '')?>/>
        </div>
        <!-- title of issue -->
        <div class="form-group">
          <label class="inline control-label" for="sarticle"><?=$this->transEsc("DDS::form_field_title")?>:</label>
          <? if (isset($this->error->article)): ?>
            <div class="error-field">
              <?=$this->error->article;?>
            </div>
          <? endif; ?>
          <input type="text" id="sarticle" name="subito[article]" class="form-control" <?=(!empty($this->article) ? 'value="' . $this->article . '"' : '')?>/>
        </div>
        <!-- title of journal -->
        <div class="form-group">
          <label class="inline control-label" for="sjournal"><?=$this->transEsc("DDS::form_field_journal")?>:*</label>
          <? if (isset($this->error->journal)): ?>
            <div class="error-field">
              <?=$this->error->journal;?>
            </div>
          <? endif; ?>
          <input type="text" id="sjournal" name="subito[journal]" class="form-control" <?=(!empty($this->journal) ? 'value="' . $this->journal . '"' : '')?>/>
        </div>
        <!-- issn -->
        <div class="form-group">
          <label class="inline control-label" for="sjournal"><?=$this->transEsc("ISSN")?>:</label>
          <? if (isset($this->error->issn)): ?>
            <div class="error-field">
              <?=$this->error->issn;?>
            </div>
          <? endif; ?>
          <input type="text" id="sissn" name="subito[issn]" class="form-control" <?=(!empty($this->issn) ? 'value="' . $this->issn . '"' : '')?>/>
        </div>
        <!-- publish date -->
        <div class="form-group">
          <label class="inline control-label" for="spublishdate"><?=$this->transEsc("DDS::form_field_publishing_date")?>:*</label>
          <? if (isset($this->error->publishdate)): ?>
            <div class="error-field">
              <?=$this->error->publishdate;?>
            </div>
          <? endif; ?>
          <input type="text" id="spublishdate" name="subito[publishdate]" class="form-control" <?=(!empty($this->publishdate) ? 'value="' . $this->publishdate . '"' : '')?>/>
        </div>
        <!-- journal number -->
        <div class="form-group">
          <label class="inline control-label" for="snumber"><?=$this->transEsc("DDS::form_field_volume")?>:*</label>
          <? if (isset($this->error->number)): ?>
            <div class="error-field">
              <?=$this->error->number;?>
            </div>
          <? endif; ?>
          <input type="text" id="snumber" name="subito[number]" class="form-control" <?=(!empty($this->number) ? 'value="' . $this->number . '"' : '')?>/>
        </div>
        <!-- pages -->
        <div class="form-group">
          <label class="inline control-label" for="spages"><?=$this->transEsc("DDS::form_field_pages")?>:*</label>
          <? if (isset($this->error->pages)): ?>
            <div class="error-field">
              <?=$this->error->pages;?>
            </div>
          <? endif; ?>
          <input type="text" id="spages" name="subito[pages]" class="form-control" <?=(!empty($this->pages) ? 'value="' . $this->pages . '"' : '')?>/>
        </div>
        <!-- remarks -->
        <div class="form-group">
          <label class="inline control-label" for="sremarks"><?=$this->transEsc("DDS::form_fields_remarks")?>:</label>
          <? if (isset($this->error->remarks)): ?>
            <div class="error-field">
              <?=$this->error->remarks;?>
            </div>
          <? endif; ?>
          <textarea id="sremarks" name="subito[remarks]" class="form-control"><?=(!empty($this->remarks) ? $this->remarks : '')?></textarea>
        </div>
    <input role="button" type="submit" class="btn btn-primary" value="<?=$this->transEsc("DDS::form_button_submit")?>"/>

    </form>
  <div class="subito-pg margin-t">
      <?=$this->transEsc("DDS::dds_text_questions")?>
      <a href="mailto:info@ub.uni-leipzig.de?subject=<?=$this->transEsc("Dokumentenlieferdienst")?>">info@ub.uni-leipzig.de</a>
    </div>

    <div class="input-department subito-pg">
      <div><?=$this->transEsc("Bei eventuellen RÃ¼ckfragen wenden Sie sich bitte an die Abteilung Fernleihe der Medizin")?>:</div>
      <div><?=$this->transEsc("Phone")?>: +49 (0)341 - 97 14014</div>
      <div><?=$this->transEsc("Email")?>: <a href="mailto:zbmed.fernleihe@medizin.uni-leipzig.de?subject=<?=$this->transEsc("Dokumentenlieferdienst")?>">zbmed.fernleihe@medizin.uni-leipzig.de</a>
      </div>
    </div>
    <div class="subito-pg">
      <p class="required">
        * <?=$this->transEsc("DDS::dds_text_mandatory_fields")?></p>
    </div>
  </div>

<?
$this->inlineScript()->captureStart();
echo <<<JS
  $(document).ready(function(){
        // if department already selected and post request failed then
        // rebuild select menu
        if ( $('input:hidden[name="subito\\[hdepartment\\]"]').val() != 'undefined') {
            department.addDepartmentSelect(
                    $('input[name="subito\\[hdepartment\\]"]').val(),
                    $('select[name="subito\\[division\\]"]').val()
            );
        }
        $('select[name="subito\\[division\\]"]').change(function() {
            department.init($(this).val());
        });
        $('.form-group input').focus(function() {
            $(this).parent().prev('.error-field').hide(200);
        });
        $('.form-group select').focus(function() {
            $(this).parent().prev('.error-field').hide(200);
        });
        /*if ( $('#loginOptions a.login').length ) {
            var loginUrl = {
              followup: true,
              followupModule: 'Subito',
              followupAction: 'Subito'
            };
            $('#loginOptions a.login').attr('href', function ( index, value ) {
                return value + '?' + $.param( loginUrl );
            });
            // console.log($('#loginOptions a.login').attr('href'));
        }*/
    });
/**
* Show & hide of subito form elements regarding select menu status.
* Add options for department select menu
*
* @author Frank Morgner<morgnerf@ub.uni-leipzig.de>
* @see https://katalog.ub.uni-leipzig.de/Subito/Subito
**/

var department = {
    init: function ( divisionid ) {
        addOptions = false;
        var elements = [];
        if ( divisionid == '15') {
            elements = {
                "department":"show",
                "costcentre":"show",
                "sdepartment":"hide"
            }
        } else if (divisionid == '') {
            elements = {
                "department":"hide",
                "costcentre":"hide",
                "sdepartment":"hide"
            }
        } else {
            elements = {
                "department":"hide",
                "costcentre":"hide",
                "sdepartment":"show"
            }
            var addOptions = true;
        }
        department.showHideElements(elements);
        if (addOptions == true) {
            department.addDepartmentOptions( divisionid );
        }
    },
    addDepartmentOptions: function ( divisionid ) {
        $('select[name="subito\\[department\\]"]').empty();
        var departments = $this->departments;
        department.addOptionElement('','');
        $.each(departments[divisionid], function (index, value) {
            department.addOptionElement(value,index);
        });
    },
    addDepartmentSelect: function (departmentid, divisionid) {
        department.init ( divisionid );
        department.addSelectElement ( departmentid );
    },
    addOptionElement: function ( text, value ) {
        jQuery('<option/>', {
                text: department.htmlEntitiesDecode(text),
                value: value
        }).appendTo('select[name="subito\\[department\\]"]');
    },
    addSelectElement: function ( departmentid )  {
        $('select[name="subito\\[department\\]"] option').filter(function () {
            //console.log($(this).val() + ' == ' + departmentid);
            return $(this).val() == departmentid;
        }).prop('selected', true);
    },
    htmlEntitiesDecode: function ( value ) {
        if (value) {
            return jQuery('<div/>').html(value).text();
        }
        return value;
    },
    showHideElements: function ( elements ) {
        $.each(elements, function (index, value) {
            if (value == 'show') {
                $('.input-' + index).show(200);
            }
            if (value == 'hide') {
                $('.input-' + index).hide(200);
            }
        });
    }
}
JS;
$this->inlineScript()->captureEnd();

echo $this->inlineScript();
?>
<!-- finc - documentdeliveryservice - form - END -->
